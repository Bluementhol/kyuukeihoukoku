<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>休憩管理</title>
    <style>
        :root {
            --yamato-green: #00693E;
            --yamato-green-dark: #004d2e;
            --yamato-green-light: #008F52;
            --yamato-yellow: #FFD900;
            --yamato-yellow-dark: #E6C300;
            --yamato-yellow-light: #FFED4E;
            --bg-color: #ffffff;
            --container-bg: #f5f5f5;
            --text-color: #000000;
            --secondary-text: #666666;
            --accent-work: #FFD900;
            --accent-break: #ff3b30;
        }

        html {
            height: 100%;
        }

        /* --- Dark Mode Overrides --- */
        body.dark-mode {
            --bg-color: #0d1117;
            --container-bg: #161b22;
            --text-color: #e6edf3;
            --secondary-text: #8b949e;
            --border-color: #30363d;

            --yamato-green: #238636;
            --yamato-green-dark: #196c2e;
            --yamato-green-light: #2ea043;

            --yamato-yellow: #d29922;
            --yamato-yellow-dark: #b88a1e;
            --yamato-yellow-light: #e3b341;

            --accent-work: #d29922;
            --accent-break: #f85149;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            height: 100%;
            height: 100dvh;
            /* 動的ビューポート高さを優先 */
            display: flex;
            flex-direction: column;
            overflow: hidden;
            -webkit-user-select: none;
            user-select: none;
        }

        /* --- Working View --- */
        #workingView {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
        }

        .main-action-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: var(--bg-color);
            gap: 20px;
            transition: all 0.3s ease;
        }

        .working-timer-group {
            text-align: center;
            margin-bottom: 10px;
        }

        .working-timer-label {
            color: var(--secondary-text);
            font-size: 0.9rem;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .working-timer-value {
            font-size: 3.5rem;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
            color: var(--text-color);
            transition: color 0.3s ease;
        }

        .working-timer-value.overtime {
            color: var(--accent-break);
        }

        .start-btn {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            border: 4px solid var(--yamato-yellow);
            background: linear-gradient(135deg, var(--yamato-green), var(--yamato-green-light));
            color: var(--yamato-yellow);
            font-size: 1.6rem;
            font-weight: bold;
            box-shadow: 0 10px 30px rgba(0, 105, 62, 0.4);
            cursor: pointer;
            outline: none;
            -webkit-tap-highlight-color: transparent;
            transition: transform 0.1s, box-shadow 0.3s;
        }

        .start-btn:active {
            transform: scale(0.95);
            box-shadow: 0 5px 20px rgba(0, 105, 62, 0.5);
        }

        /* --- Bottom Tray (History & Footer) --- */
        .bottom-tray {
            background-color: var(--container-bg);
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
            padding: 24px;
            display: flex;
            flex-direction: column;
            border-top: 2px solid var(--yamato-green);
            box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.05);
            max-height: 80vh;
        }

        .history-title {
            font-size: 0.8rem;
            color: var(--secondary-text);
            margin-bottom: 12px;
            font-weight: 600;
            text-transform: uppercase;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            -webkit-tap-highlight-color: transparent;
            padding: 5px 0;
        }

        .history-title::after {
            content: '▼';
            font-size: 0.6rem;
            color: var(--yamato-green);
            transition: transform 0.3s;
        }

        .collapsed .history-title::after {
            content: '▲';
        }

        /* --- Theme Toggle Switch --- */
        .theme-switch-container {
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }

        .switch-label {
            font-size: 0.75rem;
            font-weight: 800;
            color: var(--secondary-text);
            width: 14px;
            text-align: center;
        }

        .switch-track {
            position: relative;
            width: 44px;
            height: 22px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 11px;
            transition: background 0.3s;
        }

        body.dark-mode .switch-track {
            background: rgba(255, 255, 255, 0.2);
        }

        .switch-thumb {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 18px;
            height: 18px;
            background: #ffffff;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body.dark-mode .switch-thumb {
            transform: translateX(22px);
            background: #ffffff;
        }

        .history-list-container {
            flex: 1;
            overflow-y: auto;
            max-height: 40vh;
            /* Expands to this size */
            transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
            -webkit-overflow-scrolling: touch;
        }

        .collapsed .history-list-container {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            margin-bottom: 0;
        }

        .history-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            padding: 14px 0;
            border-bottom: 1px solid #e0e0e0;
            font-size: 0.95rem;
            color: var(--text-color);
        }

        .footer-action {
            margin-top: 20px;
            display: flex;
            gap: 12px;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .action-btn {
            flex: 1;
            background: var(--yamato-yellow);
            border: 1px solid var(--yamato-yellow-dark);
            color: var(--yamato-green);
            padding: 14px 10px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-tap-highlight-color: transparent;
            transition: background 0.2s;
        }

        .action-btn:active {
            background: var(--yamato-yellow-dark);
        }

        /* --- Hidden Reset Trigger --- */
        .hidden-reset-trigger {
            position: fixed;
            top: 0;
            left: 0;
            width: 60px;
            height: 60px;
            z-index: 9999;
            background: transparent;
        }

        /* --- Break View --- */
        #breakOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #ffffff;
            z-index: 1000;
            flex-direction: column;
            justify-content: center;
            /* 中央に配置 */
            align-items: center;
            box-sizing: border-box;
            color: var(--text-color);
        }

        .break-status-text {
            font-size: 25vw;
            /* 画面幅に合わせて伸縮 */
            font-weight: 800;
            color: var(--accent-break);
            margin-bottom: 20px;
            line-height: 1.1;
            white-space: nowrap;
            /* 改行を防止 */
            animation: pulse-animation 2s infinite ease-in-out;
            text-align: center;
            cursor: pointer;
            /* 追加: クリック可能であることを示す */
            -webkit-tap-highlight-color: transparent;
        }

        @keyframes pulse-animation {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.05);
                opacity: 0.8;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .break-timer-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 60px;
        }

        .break-timer-value {
            font-size: 3.5rem;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
            color: var(--text-color);
            /* 黒固定から変数に変更 */
            transition: color 0.3s ease;
            cursor: pointer;
            /* 追加: クリック可能であることを示す */
            -webkit-tap-highlight-color: transparent;
        }

        /* --- Steam Effect --- */
        .steam-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 0;
        }

        .steam-particle {
            position: absolute;
            bottom: -150px;
            background: rgba(200, 200, 200, 0.1);
            border-radius: 50%;
            filter: blur(40px);
            animation: rise-animation 10s infinite ease-in;
        }

        /* --- Dark Mode Video --- */
        #darkSmokeVideo {
            display: none;
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 0;
            opacity: 0.5;
        }

        body.dark-mode .steam-container {
            display: none;
            /* ダークモード時はCSS湯気を隠す */
        }

        body.dark-mode #darkSmokeVideo {
            display: block;
            /* ダークモード時は動画を表示 */
        }

        body.dark-mode #breakOverlay {
            background-color: #0d1117;
        }

        @keyframes rise-animation {
            0% {
                transform: translateY(0) scale(1) translateX(0);
                opacity: 0;
            }

            10% {
                opacity: 0.4;
            }

            50% {
                transform: translateY(-50vh) scale(2) translateX(20px);
                opacity: 0.3;
            }

            100% {
                transform: translateY(-110vh) scale(3) translateX(-20px);
                opacity: 0;
            }
        }

        .break-timer-value.overtime {
            color: var(--accent-break);
        }

        .overtime-msg {
            display: none;
            color: var(--accent-break);
            font-size: 1.2rem;
            font-weight: 800;
            margin-top: 10px;
            animation: flash 1s infinite alternate;
        }

        @keyframes flash {
            from {
                opacity: 1;
            }

            to {
                opacity: 0.4;
            }
        }

        .break-history-section {
            width: 100%;
            display: flex;
            flex-direction: column;
            padding: 0 40px;
            box-sizing: border-box;
            transition: all 0.3s ease;
            position: absolute;
            bottom: 40px;
        }

        .break-history-title {
            font-size: 0.85rem;
            color: #ccc;
            margin-bottom: 12px;
            font-weight: 600;
            text-transform: uppercase;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            -webkit-tap-highlight-color: transparent;
        }

        .break-history-title::after {
            content: '▼';
            font-size: 0.6rem;
            color: #ddd;
            transition: transform 0.3s;
        }

        .break-history-collapsed .break-history-title::after {
            content: '▲';
        }

        .break-history-list-container {
            flex: 1;
            overflow-y: auto;
            max-height: 30vh;
            transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
            -webkit-overflow-scrolling: touch;
            touch-action: pan-y;
        }

        .break-history-collapsed .break-history-list-container {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }

        .break-history-list .history-item {
            color: var(--text-color);
            border-bottom: 1px solid var(--border-color);
        }

        .tap-hint {
            padding: 40px 0;
            width: 100%;
            text-align: center;
            color: #ddd;
            font-size: 0.9rem;
        }

        /* --- Landscape Orientation Adjustments --- */
        @media (orientation: landscape) {
            #breakOverlay {
                justify-content: flex-start;
                /* 上寄せ目にしてpaddingで調整 */
                padding-top: 10vh;
                /* 文字を少し下げる */
            }

            .break-status-text {
                font-size: 50vh;
                /* 40vhから50vhに拡大 */
                margin-bottom: 0px;
                /* 5pxから0pxに */
            }

            .break-timer-container {
                margin-bottom: 20px;
            }

            .break-history-section {
                bottom: 20px;
            }
        }
    </style>
</head>

<body>
    <div id="workingView">
        <div class="theme-switch-container" onclick="toggleTheme(event)">
            <span class="switch-label">L</span>
            <div class="switch-track">
                <div class="switch-thumb"></div>
            </div>
            <span class="switch-label">D</span>
        </div>
        <div class="hidden-reset-trigger" id="hiddenResetTrigger"></div>
        <div class="main-action-area" id="timerArea">
            <div class="working-timer-group">
                <div class="working-timer-label">残り休憩時間</div>
                <div id="workTimerDisplay" class="working-timer-value">60:00</div>
            </div>
            <button id="startBtn" class="start-btn">休憩開始</button>
        </div>
        <div class="bottom-tray" id="bottomTray">
            <div class="history-title" onclick="toggleHistory()">本日の履歴</div>
            <div class="history-list-container">
                <ul id="workingHistoryList" class="history-list"></ul>
            </div>
            <div class="footer-action">
                <button id="csvBtn" class="action-btn">CSV出力</button>
                <button id="emailBtn" class="action-btn">業務終了送信</button>
            </div>
        </div>
    </div>

    <div id="breakOverlay">
        <div class="theme-switch-container" onclick="toggleTheme(event)">
            <span class="switch-label" style="color: #666;">L</span>
            <div class="switch-track">
                <div class="switch-thumb"></div>
            </div>
            <span class="switch-label" style="color: #666;">D</span>
        </div>
        <video autoplay muted loop playsinline id="darkSmokeVideo">
            <source src="assets/smoke-rising-loop.mp4" type="video/mp4">
        </video>
        <div class="steam-container">
            <div class="steam-particle"
                style="left: 10%; width: 200px; height: 200px; animation-delay: 0s; animation-duration: 8s;"></div>
            <div class="steam-particle"
                style="left: 30%; width: 250px; height: 250px; animation-delay: 2s; animation-duration: 12s;"></div>
            <div class="steam-particle"
                style="left: 50%; width: 150px; height: 150px; animation-delay: 4s; animation-duration: 9s;"></div>
            <div class="steam-particle"
                style="left: 70%; width: 220px; height: 220px; animation-delay: 1s; animation-duration: 11s;"></div>
            <div class="steam-particle"
                style="left: 90%; width: 180px; height: 180px; animation-delay: 5s; animation-duration: 13s;"></div>
        </div>
        <div class="break-status-text" style="position: relative; z-index: 10;">休憩中</div>
        <div class="break-timer-container" style="position: relative; z-index: 10;">
            <div id="breakTimer" class="break-timer-value">60:00</div>
            <div id="overtimeMsg" class="overtime-msg">早く業務に戻りましょう！</div>
        </div>
        <div class="break-history-section" id="breakHistorySection">
            <div class="break-history-title" onclick="toggleBreakHistory()">本日の履歴</div>
            <div class="break-history-list-container">
                <ul id="breakHistoryList" class="history-list break-history-list"></ul>
            </div>
        </div>
    </div>

    <script>
        const MAX_TIME_MS = 60 * 60 * 1000;
        const AUTO_STOP_MS = 7.5 * 60 * 1000; // 7分30秒

        let state = {
            remainingMs: MAX_TIME_MS,
            isBreak: false,
            lastBreakStartTimestamp: null,
            history: [],
            lastCheckedDate: ""
        };

        const workingView = document.getElementById('workingView');
        const breakOverlay = document.getElementById('breakOverlay');
        const breakTimer = document.getElementById('breakTimer');
        const workTimerDisplay = document.getElementById('workTimerDisplay');
        const workingHistoryList = document.getElementById('workingHistoryList');
        const breakHistoryList = document.getElementById('breakHistoryList');
        const startBtn = document.getElementById('startBtn');
        const emailBtn = document.getElementById('emailBtn');
        const csvBtn = document.getElementById('csvBtn');
        const hiddenResetTrigger = document.getElementById('hiddenResetTrigger');

        function init() {
            loadState();
            checkDateRollover();

            // 履歴の開閉状態を復元 (メイン)
            const isCollapsed = localStorage.getItem('history_collapsed') !== 'false';
            if (isCollapsed) {
                document.getElementById('bottomTray').classList.add('collapsed');
            }

            // 履歴の開閉状態を復元 (休憩中)
            const isBreakCollapsed = localStorage.getItem('break_history_collapsed') !== 'false';
            if (isBreakCollapsed) {
                document.getElementById('breakHistorySection').classList.add('break-history-collapsed');
            }

            if (state.isBreak) showBreakMode();
            else showWorkingMode();

            // テーマの復元
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                const v = document.getElementById('darkSmokeVideo');
                if (v) v.playbackRate = 0.6;
            }

            updateAllTimerDisplays(state.remainingMs);
            renderHistory();
            requestAnimationFrame(tick);
        }

        function checkDateRollover() {
            const today = new Date().toDateString();
            if (state.lastCheckedDate && state.lastCheckedDate !== today) {
                if (state.isBreak) endBreak();
                resetToNewDay(today);
            } else {
                state.lastCheckedDate = today;
                saveState();
            }
        }

        function resetToNewDay(newDate) {
            state = {
                remainingMs: MAX_TIME_MS,
                isBreak: false,
                lastBreakStartTimestamp: null,
                history: [],
                lastCheckedDate: newDate
            };
            saveState();
            updateAllTimerDisplays(state.remainingMs);
            renderHistory();
            showWorkingMode();
        }

        let lastSecond = 0;
        function tick() {
            const now = Date.now();
            if (now - lastSecond > 1000) {
                checkDateRollover();
                lastSecond = now;
            }
            if (state.isBreak) {
                const sessionElapsed = now - state.lastBreakStartTimestamp;

                // オートストップ判定 (7分30秒経過)
                if (sessionElapsed >= AUTO_STOP_MS) {
                    endBreak(true);
                    return;
                }

                const currentRemaining = state.remainingMs - sessionElapsed;
                updateAllTimerDisplays(currentRemaining);
            }
            requestAnimationFrame(tick);
        }

        startBtn.addEventListener('click', startBreak);

        // 休憩終了のトリガーを特定要素に限定
        document.querySelector('.break-status-text').addEventListener('click', endBreak);
        document.getElementById('breakTimer').addEventListener('click', endBreak);

        document.querySelectorAll('#bottomTray, #breakHistorySection, .history-title, .break-history-title, .history-list-container, .break-history-list-container, .theme-switch-container').forEach(el => {
            el.addEventListener('click', (e) => e.stopPropagation());
        });

        function startBreak() {
            state.isBreak = true;
            state.lastBreakStartTimestamp = Date.now();
            saveState();
            showBreakMode();
        }

        function endBreak(isAuto = false) {
            if (!state.isBreak) return;
            const now = Date.now();
            const sessionElapsed = now - state.lastBreakStartTimestamp;
            state.remainingMs = state.remainingMs - sessionElapsed;
            const start = new Date(state.lastBreakStartTimestamp);
            const end = new Date(now);
            const item = {
                startStr: formatTime(start),
                endStr: formatTime(end),
                durationStr: formatDuration(sessionElapsed),
                isAuto: isAuto
            };
            state.history.push(item);
            state.isBreak = false;
            state.lastBreakStartTimestamp = null;
            saveState();
            updateAllTimerDisplays(state.remainingMs);
            showWorkingMode();
            renderHistory();
        }

        function showBreakMode() {
            workingView.style.display = 'none';
            breakOverlay.style.display = 'flex';
        }

        function showWorkingMode() {
            workingView.style.display = 'flex';
            breakOverlay.style.display = 'none';
        }

        function toggleHistory() {
            const tray = document.getElementById('bottomTray');
            tray.classList.toggle('collapsed');
            localStorage.setItem('history_collapsed', tray.classList.contains('collapsed'));
        }

        function toggleBreakHistory() {
            const section = document.getElementById('breakHistorySection');
            section.classList.toggle('break-history-collapsed');
            localStorage.setItem('break_history_collapsed', section.classList.contains('break-history-collapsed'));
        }

        function toggleTheme(e) {
            if (e) e.stopPropagation();
            const isDark = document.body.classList.toggle('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            if (isDark) {
                const v = document.getElementById('darkSmokeVideo');
                if (v) v.playbackRate = 0.6;
            }
        }
        // updateThemeBtnText() は不要になったため削除

        function updateAllTimerDisplays(ms) {
            const str = formatTimer(ms);
            breakTimer.innerText = str;
            workTimerDisplay.innerText = str;

            const overtimeMsg = document.getElementById('overtimeMsg');
            if (ms < 0) {
                breakTimer.classList.add('overtime');
                workTimerDisplay.classList.add('overtime');
                overtimeMsg.style.display = 'block';
            } else {
                breakTimer.classList.remove('overtime');
                workTimerDisplay.classList.remove('overtime');
                overtimeMsg.style.display = 'none';
            }
        }

        function formatTimer(ms) {
            const isNegative = ms < 0;
            const totalSeconds = Math.ceil(Math.abs(ms) / 1000);
            const m = Math.floor(totalSeconds / 60);
            const s = totalSeconds % 60;
            return (isNegative ? "-" : "") + `${pad(m)}:${pad(s)}`;
        }
        function pad(n) { return n < 10 ? '0' + n : n; }
        function formatTime(d) { return `${pad(d.getHours())}:${pad(d.getMinutes())}`; }
        function formatDuration(ms) {
            const sec = Math.floor(ms / 1000);
            return `${Math.floor(sec / 60)}分${sec % 60}秒`;
        }

        function renderHistory() {
            const html = state.history.map(h => `
                <li class="history-item">
                    <span>${h.startStr} - ${h.endStr}${h.isAuto ? ' <small style="color:var(--text-color); font-weight:bold; opacity:0.8;">(自動停止)</small>' : ''}</span>
                    <span>${h.durationStr}</span>
                </li>
            `).join('');
            workingHistoryList.innerHTML = html;
            breakHistoryList.innerHTML = html;
        }

        function saveState() {
            localStorage.setItem('breakApp_final', JSON.stringify(state));
        }

        function loadState() {
            const saved = localStorage.getItem('breakApp_final');
            if (saved) state = JSON.parse(saved);
            else state.lastCheckedDate = new Date().toDateString();
        }

        emailBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            let body = "お疲れ様です。\n本日の休憩取得状況をご報告します。\n\n本日の休憩履歴:\n";
            state.history.forEach(h => {
                body += `${h.startStr} - ${h.endStr} (${h.durationStr})${h.isAuto ? ' [自動停止]' : ''}\n`;
            });
            body += `\n合計休憩時間: ${formatDuration(MAX_TIME_MS - state.remainingMs)}\n\n明日もよろしくお願いします。`;
            window.location.href = `mailto:?subject=休憩取得状況報告&body=${encodeURIComponent(body)}`;
        });

        csvBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            downloadCSV();
        });

        // 隠しリセット：トリプルタップ（3回連続クリック）判定
        let clickCount = 0;
        let lastClickTime = 0;
        hiddenResetTrigger.addEventListener('click', (e) => {
            e.stopPropagation();
            const now = Date.now();
            if (now - lastClickTime < 500) {
                clickCount++;
            } else {
                clickCount = 1;
            }
            lastClickTime = now;

            if (clickCount >= 3) {
                if (confirm("【隠し機能】本日の全てのデータ（残り時間と履歴）を完全にリセットしてもよろしいですか？")) {
                    resetToNewDay(new Date().toDateString());
                    alert("全てのデータをリセットしました。");
                }
                clickCount = 0;
            }
        });

        function downloadCSV() {
            if (state.history.length === 0) { alert("履歴がありません"); return; }
            let csvContent = "開始時刻,終了時刻,経過時間,備考\n";
            state.history.forEach(h => {
                csvContent += `${h.startStr},${h.endStr},${h.durationStr},${h.isAuto ? '自動停止' : ''}\n`;
            });
            const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
            const blob = new Blob([bom, csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            const now = new Date();
            const dateStr = `${now.getFullYear()}${pad(now.getMonth() + 1)}${pad(now.getDate())}`;
            link.setAttribute('download', `休憩実績_${dateStr}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        init();
        document.body.addEventListener('touchstart', function () { }, false);
        document.addEventListener('DOMContentLoaded', function () {
            const video = document.getElementById('darkSmokeVideo');
            if (!video) return;

            let fadeDuration = 8;          // ← ここを調整！ フェードにかける秒数（4〜6秒が自然になりやすい）

            video.addEventListener('timeupdate', function () {
                const duration = video.duration;   // ≈30秒
                const current = video.currentTime;

                // 最後のfadeDuration秒でフェードアウト
                if (current > duration - fadeDuration) {
                    const progress = (current - (duration - fadeDuration)) / fadeDuration;
                    video.style.opacity = 1 - Math.pow(progress, 2);  // 2乗で後半がゆっくり薄くなる	
                }
                // 最初のfadeDuration秒でフェードイン
                else if (current < fadeDuration) {
                    const progress = current / fadeDuration;
                    video.style.opacity = Math.pow(progress, 0.5);  // フェードインをゆっくりスタート
                }
                else {
                    video.style.opacity = 1;
                }
            });

            // endedイベントは保険として残す（ループ属性があるので基本発火しないが）
            video.addEventListener('ended', function () {
                video.currentTime = 0;
                video.play();
                video.style.opacity = 0;  // 念のため最初透明からスタート
            });
        });
    </script>
</body>

</html>